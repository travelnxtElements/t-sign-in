<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../t-shared-components/t-provider-behavior.html">

<dom-module id="t-sign-in-api">
	<template>
		<iron-ajax id="ajaxCall" 
            method="POST"            
            content-type="application/json"
            handle-as="json"
            verbose>
        </iron-ajax>		
	</template>
</dom-module>

<script>
	Polymer({
		is: "t-sign-in-api",

		behaviors: [TravelNxt.Behaviors.ProviderBehavior],

	    listeners: {
	        'ajaxCall.response': '_successCallback',
	        'ajaxCall.error': '_errorCallback'
	    },

	    login: function(data){
	    	//validate API meta before making a call
	    	if(this._validateApiMeta()){
		    	var request = {
							"UserCredentials": {
								"UserName": data.username,
								"Password": data.password
							}
						};
				this.$.ajaxCall.body = request;
				this.$.ajaxCall.generateRequest();
			}
	    },

	    _successCallback: function(event){
	        if(!event.detail.response || !event.detail.response.status || event.detail.response.status.code == 500)
	            this.fire('t-sign-in-api-error', { message: 'Operation error occured, please try again.', code: 500}, { bubbles: true });
	        else if(!event.detail.response.status.isSuccessful){
	            this.fire('t-sign-in-api-error', event.detail.response.status, {bubbles: true});
	        }
	        else{
	        	//do special handling as per api status codes
	            this.fire('t-sign-in-api-success', event.detail.response, { bubbles: true});
	        }
	    },

	    _errorCallback: function(event){
	        this.fire('t-sign-in-api-error', { message: 'Connection error occured, please try again.', code: event.request.status }, { bubbles: true });
	        console.error('t-sign-in-api-error', event);
	    },

	});	
</script>