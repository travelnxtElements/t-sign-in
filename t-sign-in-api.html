_<liLrel="import" href="../polymer/polym(html)" >
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../t-shared-lib/t-provider-behavior.html">

<dom-module id="t-sign-in-api">
	<template>
		<iron-ajax id="ajaxCall" 
            method="POST"            
            content-type="application/json"
            handle-as="json"
            verbose>
        </iron-ajax>		
	</template>
</dom-module>

<script>
	Polymer({
		is: "t-sign-in-api",

		behaviors: [TravelNxt.Behaviors.ProviderBehavior],

		properties:{
			/*
			Username
			 */
			username: String,

			/*
			Password
			 */
			password: String,
		},

	    listeners: {
	        'ajaxCall.response': '_successCallback',
	        'ajaxCall.error': '_errorCallback'
	    },

	    /*
	    Authenticates user with given username and password
	     */
	    authenticate: function(){	  
	    	//validate API meta before making a call
	    	if(this._validateApiMeta()){
		    	var request = {
							"UserCredentials": {
								"UserName": this.username,
								"Password": this.password
							}
						};
				this.$.ajaxCall.url = this._getUrl();
				this.$.ajaxCall.body = JSON.stringify(request);
				this._setLoading(true);
				this.$.ajaxCall.generateRequest();
			}
	    },

	    /*
	    Callback for t-sign-in-authenticate event from UI component
	     */
	    onAuthenticate: function(e){
	    	this.username = e.detail.username;
	    	this.password = e.detail.password;
	    	this.authenticate();
	    },


	    /*
	    Callback for authenticate iron ajax success evnt
	     */
	    _successCallback: function(event){
	    	//mystique authenticate api error code
	    	var operationErrors = [316000, //Error occurred while processing the user request.
	    						  500];
	    	var invalidCredErrors = [316200, //Invalid Username
	    							316300,  //Logged in user not found.
	    							316800,  //Unable to retrieve particular user or user was not found in the system.
	    							316900]; //User authentication has failed.
	    	var miscErros = [316407,  //Password cannot be same as previous 3 passwords.
	    					 316405  //Password has expired. Please set a new password.
	    					 316403]; //Account locked due to wrong password attempts. Contact administrator or return after some time

	    	var error = null;
	    	var success = null;

	        if(!event.detail.response || !event.detail.response.status || (!event.detail.response.status.isSuccessful && operationErrors.indexOf(event.detail.response.status.code)!= -1) ){	        	
	        	error = { message: 'Operation error occured, please try again.', code: 500};
	        	this.fire('t-sign-in-api-authenticate-error', error, { bubbles: true });	        
	        }
	        else if(!event.detail.response.status.isSuccessful && invalidCredErrors.indexOf(event.detail.response.status.code)!= -1 ){
	        	error ={ message: 'Invalid credentials, please try again.', code: event.detail.response.status.code};
	            this.fire('t-sign-in-api-authenticate-error', error, { bubbles: true });	     
	        }
	        else if(!event.detail.response.status.isSuccessful && miscErros.indexOf(event.detail.response.status.code)!= -1 ){
	        	error = { message: event.detail.response.status.message, code: event.detail.response.status.code}
	            this.fire('t-sign-in-api-authenticate-error', error, { bubbles: true });	     
	        }
	        else{	     
	        	success = event.detail.response;
	            this.fire('t-sign-in-api-authenticate-success', {authenticationToken: event.detail.response.authenticationToken}, { bubbles: true});
	        }

	        if(error)
	        	this._setLastError(error);
	        else if(success)
	        	this._setLastResponse(success);

	        this._setLoading(false);
	    },


	    /*
	    Callback for authenticate iron ajax success evnt
	     */
	    _errorCallback: function(event){	    	
	    	var error ={ message: 'Connection error occured, please try again.', code: event.detail.request.status };
	    	this._setLastError(error);
	        this._setLoading(false);

	        this.fire('t-sign-in-api-authenticate-error', error, { bubbles: true });
	        console.error('t-sign-in-api-authenticate-error', event);
	    },

	    /**
		* Fired when authentication API succeeds
		*
		* @event t-sign-in-api-authenticate-success
		* @param {{authenticationToken: string}}
		* @param authenticationToken 
		*/
	
		/**
		* Fired when authentication API fails
		*
		* @event t-sign-in-api-authenticate-error
		* @param {{message:string, code: string}} detail -
     	* Invalid credentials error codes - 316200, 316800, 316900
     	* Operation error codes - 316000, 500
     	* Misc error codes - 316407(Password cannot be same as previous 3 passwords), 316405(Password has expired. Please set a new password), 316403(Account locked due to wrong password attempts. Contact administrator or return after some time)
     	* Incase network error, brower error code and message will be set in it
     	* In all these cases 'lastError' field will be updated with proper message and error code
		*/

	});	
</script>